<header id="site-header" class="bg-white/95 backdrop-blur-sm fixed w-full z-40 shadow-none transition-all duration-200 ease-out" style="top:0;">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">

    <!-- LEFT: Logo -->
    <a href="/" class="flex items-center gap-3 logo-wrap" aria-label="ReadHub home">
      <div class="w-10 h-10 rounded-md flex items-center justify-center" style="background:#bbf7d0;">
        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none">
          <path d="M3 21l3-1 11-11 1-3-3 1L7 17 3 21z" fill="currentColor"/>
        </svg>
      </div>
      <div class="brand-text">
        <div class="font-bold text-lg text-slate-900">ReadHub</div>
        <div class="text-xs muted">Summaries in seconds</div>
      </div>
    </a>

    <!-- CENTER NAV -->
    <nav id="main-nav" class="hidden md:flex items-center gap-8 text-sm text-slate-700">
      <a href="/" class="nav-link">Home</a>
      <a href="/history" class="nav-link">History</a>

      <% if (user && user.isSubscriber) { %>
        <a href="/pricing" class="nav-link">Pro Guide</a>
      <% } else { %>
        <a href="/pricing" class="nav-link">Pricing</a>
      <% } %>

      <a href="/contact" class="nav-link">Contact</a>
    </nav>

    <!-- RIGHT SIDE -->
    <div class="flex items-center gap-3">

      <% if (user) { %>

        <% if (!user.isSubscriber) { %>
          <a href="/pricing"
             class="hidden sm:inline-flex items-center px-3 py-2 rounded-full text-sm font-medium upgrade-pill bg-slate-900 text-white shadow-sm hover:bg-black/80">
            Upgrade
          </a>
        <% } else { %>
          <a href="/subscription/manage"
             class="hidden sm:inline-flex items-center px-3 py-2 rounded-full text-sm font-medium bg-emerald-100 text-emerald-800 border border-emerald-300 shadow-sm hover:bg-emerald-200">
            Manage
          </a>
        <% } %>

        <!-- USER DROPDOWN -->
        <div class="relative">
          <button id="user-menu-btn" class="flex items-center gap-2 avatar-btn focus:outline-none" type="button">

            <% if (user.profileImageURL) { %>
              <img src="<%= user.profileImageURL %>" class="w-9 h-9 rounded-full border object-cover"/>
            <% } else if (user.fullname) {
                 var initials = user.fullname.split(' ').map(a => a[0]).join('').slice(0,2).toUpperCase();
            %>
              <div class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-200 text-sm font-medium border">
                <%= initials %>
              </div>
            <% } else { %>
              <img src="/images/defaultuser.webp" class="w-9 h-9 rounded-full border object-cover"/>
            <% } %>

            <span class="hidden sm:flex items-center gap-2 text-gray-800 font-medium">
              <%= (user.fullname || '').split(' ')[0] || 'User' %>

              <% if (user.isSubscriber) { %>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 border border-emerald-300">
                  Pro
                </span>
              <% } %>
            </span>

            <svg class="w-3 h-3 text-gray-600 hidden sm:inline" viewBox="0 0 20 20">
              <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.67l3.71-3.48a.75.75 0 111.04 1.08l-4.25 4a.75.75 0 01-1.04 0l-4.25-4a.75.75 0 01-.02-1.06z"/>
            </svg>
          </button>

          <div id="user-menu" class="hidden absolute right-0 mt-2 bg-white border rounded-md shadow-lg py-2 min-w-[12rem] z-50">
            <a href="/profile" class="block px-4 py-2 text-sm hover:bg-gray-50">Profile</a>
            <a href="/history" class="block px-4 py-2 text-sm hover:bg-gray-50">History</a>
            <a href="/subscription/manage" class="block px-4 py-2 text-sm hover:bg-gray-50">Manage subscription</a>
            <form action="/auth/logout" method="POST">
              <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50">Logout</button>
            </form>
          </div>
        </div>

      <% } else { %>

        <a href="/auth/signin" class="px-3 py-2 rounded-md border text-sm">Sign In</a>
        <a href="/auth/signup" class="px-3 py-2 rounded-md bg-slate-900 text-white text-sm">Sign Up</a>

      <% } %>

      <button id="mobile-toggle" class="md:hidden p-2 rounded-md text-gray-600">
        <svg class="w-6 h-6" viewBox="0 0 24 24">
          <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- MOBILE MENU -->
  <div id="mobile-menu" class="hidden md:hidden border-t bg-white/95">
    <div class="px-4 py-3 flex flex-col gap-2">
      <a href="/" class="py-2">Home</a>
      <a href="/history" class="py-2">History</a>

      <% if (user && user.isSubscriber) { %>
        <a href="/pricing" class="py-2">Pro Guide</a>
      <% } else { %>
        <a href="/pricing" class="py-2">Pricing</a>
      <% } %>

      <a href="/contact" class="py-2">Contact</a>

      <% if (user) { %>
        <a href="/profile" class="py-2">Profile</a>
        <a href="/subscription/manage" class="py-2">Manage subscription</a>

        <% if (!user.isSubscriber) { %>
          <a href="/pricing" class="py-2">Upgrade</a>
        <% } %>

        <form action="/auth/logout" method="POST" class="py-2">
          <button class="w-full text-left">Logout</button>
        </form>

      <% } else { %>
        <a href="/auth/signin" class="py-2">Sign In</a>
        <a href="/auth/signup" class="py-2">Sign Up</a>
      <% } %>

    </div>
  </div>
</header>

<script>
  (function(){
    const btn = document.getElementById('user-menu-btn');
    const menu = document.getElementById('user-menu');
    if (btn) {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('hidden');
      });
      document.addEventListener('click', () => menu.classList.add('hidden'));
    }
  })();
</script>
